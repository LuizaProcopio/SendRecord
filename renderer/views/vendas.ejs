<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css"> 
    <title>Vendas - MVERNON</title>
</head>
<body>
    
    <header class="header">
        <div class="logo">
            <img src="../img/Marca.png" alt="Logo da Loja" width="300">
        </div>
        
        <%- include('partials/header', { 
            nome: nome, 
            tipo_acesso: tipo_acesso,
            currentPage: currentPage
        }) %>
    </header>
    
    <div class="container">
        <% if (typeof sucesso !== 'undefined' && sucesso) { %>
        <div class="success-message">
            ‚úì <%= sucesso %>
        </div>
        <% } %>
        
        <% if (typeof erro !== 'undefined' && erro) { %>
        <div class="error-message">
            ‚úó <%= erro %>
        </div>
        <% } %>

        <div class="filters-section">
            <form method="GET" action="/vendas" class="search-box">
                <input type="text" name="busca" class="search-input" 
                        placeholder="Pesquisar por Order ID, Cliente, CPF/CNPJ ou NF" 
                        value="<%= typeof busca !== 'undefined' ? busca : '' %>">
            
                <button type="submit" class="btn-search">üîç Pesquisar</button>
            </form>
            
            <button class="btn-add-pedido" onclick="abrirModalNovoPedido()">
                Novo Pedido
            </button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <% if (typeof pedidos !== 'undefined') { %>
                            <th>Order ID</th>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Origem</th>
                            <th>Itens</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Prova</th>
                            <th>A√ß√µes</th>
                        <% } else { %>
                            <th>N¬∫</th>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>NF</th>
                            <th>Situa√ß√£o</th>
                            <th>A√ß√µes</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <% 
                    // Determinar qual array usar (pedidos ou vendas)
                    const dados = typeof pedidos !== 'undefined' ? pedidos : (typeof vendas !== 'undefined' ? vendas : []);
                    %>
                    
                    <% if (dados.length === 0) { %>
                        <tr>
                            <td colspan="<%= typeof pedidos !== 'undefined' ? '9' : '6' %>" class="empty-state">
                                Nenhum <%= typeof pedidos !== 'undefined' ? 'pedido' : 'venda' %> encontrado
                            </td>
                        </tr>
                    <% } else { %>
                        <% dados.forEach(function(item) { %>
                        <tr>
                            <% if (typeof pedidos !== 'undefined') { %>
                                <td>
                                    <strong><%= item.order_id %></strong>
                                </td>
                                <td>
                                    <%= new Date(item.created_at).toLocaleDateString('pt-BR') %><br>
                                    <span style="font-size: 11px; color: #666;">
                                        <%= new Date(item.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) %>
                                    </span>
                                </td>
                                <td>
                                    <%= item.customer_name %><br>
                                    <span class="item-count"><%= item.cpf_cnpj || 'Sem CPF/CNPJ' %></span>
                                </td>
                                <td>
                                    <span class="source-badge source-<%= item.source %>">
                                        <%= item.source.replace('_', ' ') %>
                                    </span>
                                </td>
                                <td>
                                    <%= item.total_itens || 0 %> item(ns)<br>
                                    <span class="item-count">Qtd: <%= item.quantidade_total || 0 %></span>
                                </td>
                                <td>
                                    R$ <%= parseFloat(item.valor_total || 0).toFixed(2).replace('.', ',') %>
                                </td>
                                <td>
                                    <span class="status-badge status-<%= item.status %>">
                                        <%= item.status.replace('_', ' ') %>
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <% if (item.imagem_prova) { %>
                                        <span class="has-image-icon">üì∑</span>
                                    <% } else { %>
                                        <span style="color: #ccc;">‚Äî</span>
                                    <% } %>
                                </td>
                            <% } else { %>
                                <td><%= item.order_id || item.numero_pedido %></td>
                                <td><%= new Date(item.data_venda || item.created_at).toLocaleDateString('pt-BR') %></td>
                                <td><%= item.nome_completo || item.customer_name %></td>
                                <td><%= item.nf || '‚Äî' %></td>
                                <td>
                                    <span class="status-badge status-<%= (item.situacao || item.status).toLowerCase() %>">
                                        <%= (item.situacao || item.status).charAt(0).toUpperCase() + (item.situacao || item.status).slice(1) %>
                                    </span>
                                </td>
                            <% } %>
                            <td>
                                <a href="/vendas/detalhes/<%= item.id %>" class="btn-ver">Ver</a>
                            </td>
                        </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modalNovoPedido" class="modal" style="display: none;">
        <div class="modal-content-large">
            <span class="modal-close" onclick="fecharModalNovoPedido()">&times;</span>
            
            <h2 style="margin-bottom: 20px;"> Novo Pedido</h2>
            
            <form id="formNovoPedido" method="POST" action="/vendas/novo">
                <div class="form-section">
                    <h3>üì¶ Dados do Pedido</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="order_id">Order ID *</label>
                            <input type="text" id="order_id" name="order_id" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="source">Origem *</label>
                            <select id="source" name="source" required>
                                <option value="">Selecione...</option>
                                <option value="Manual">Loja F√≠sica / Manual</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Mercado_Livre">Mercado Livre</option>
                                <option value="Wix">Wix / Site</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üë§ Dados do Cliente</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customer_name">Nome Completo *</label>
                            <input type="text" id="customer_name" name="customer_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="cpf_cnpj">CPF/CNPJ</label>
                            <input type="text" id="cpf_cnpj" name="cpf_cnpj">
                        </div>
                        
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="text" id="telefone" name="telefone">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üìù Observa√ß√µes</h3>
                    <textarea name="observacoes" rows="3" placeholder="Observa√ß√µes sobre o pedido (opcional)"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="fecharModalNovoPedido()">Cancelar</button>
                    <button type="submit" class="btn-submit">üíæ Salvar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function abrirModalNovoPedido() {
            document.getElementById('modalNovoPedido').style.display = 'flex';
        }

        function fecharModalNovoPedido() {
            document.getElementById('modalNovoPedido').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalNovoPedido');
            if (event.target === modal) {
                fecharModalNovoPedido();
            }
        }

        // M√°scara para CPF/CNPJ
        document.getElementById('cpf_cnpj').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                // CPF
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                // CNPJ
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });

        // M√°scara para telefone
        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 10) {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
    </script>
</body>
</html>